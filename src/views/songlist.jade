extends app
block append headpage
    title Ongaku music
block append library
    include library
block append songlist
    section.song-list
        include playlist
block append scripts
  script.
    $(function(){
      $.ongaku.library.bind();
      $.ongaku.library.fetch();
      $.ongaku.playlist.fetch();
    });
  if !session.user.isAnonymous
    script.
      $(function(){
        $.get("/api/user/playlists", function(output){
          $.each(output, function(index, playlist){
            var playlistBlock = $("<a>");
            playlistBlock.text(playlist);
            $(".playlists-elements").append(playlistBlock);
          });
        });
        $("#save-current-playlist").click(function(){
          var playlistname = $("#playlistname").val();
          $.ajax({
              url: '/api/playlist/save',
              type: 'POST',
              data: JSON.stringify({playlistname: playlistname}),
              contentType: 'application/json; charset=utf-8',
              dataType: 'json',
              async: false,
              success: function() {
                $("#save-current-playlist").prop('disabled', true);  
              }
          });
        });
        
        $('ul.dropdown-menu .playlists-elements').click(function (){
          var playlistName = $(this).text();
          $.get("/api/user/playlists/" + playlistName, function(playlist){
            $.ongaku.playlist.rebuild(playlist);
          });
        });
      });
